<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="css/admin.css" />
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

  <h1>Admin Dashboard</h1>

  <div class="nav">
    <a href="index.html">Home</a>
    <a href="report.html">Report Incident</a>
  </div>

  <div class="admin-container" id="adminList"></div>

  <script src="js/api.js"></script>

  <script>
    const ADMIN_TOKEN = "admin";

    async function loadAdminIncidents() {
      const res = await fetch(`${API_BASE}/incidents`);
      const incidents = await res.json();

      const container = document.getElementById("adminList");
      container.innerHTML = "";

      incidents.forEach(i => {
        const div = document.createElement("div");
        div.className = "admin-incident";

        div.innerHTML = `
          <strong>${i.type}</strong>
          <p>${i.description}</p>
          <p><b>Location:</b> ${i.location}</p>
          <p><b>Severity:</b> ${i.severity.toUpperCase()}
            (${i.severity_confidence})</p>
          <p><b>Status:</b> <span>${i.status}</span></p>

          <select onchange="updateStatus('${i.id}', this.value)">
            <option value="">Update Status</option>
            <option value="unverified">Unverified</option>
            <option value="in_progress">In Progress</option>
            <option value="resolved">Resolved</option>
          </select>

          <button onclick="loadTimeline('${i.id}')">View Timeline</button>
          <hr/>
        `;

        container.appendChild(div);
      });
    }

    async function updateStatus(id, status) {
      if (!status) return;

      const res = await fetch(
        `${API_BASE}/admin/incident/${id}/status?status=${status}`,
        {
          method: "PUT",
          headers: { "token": ADMIN_TOKEN }
        }
      );

      if (!res.ok) {
        const err = await res.json();
        alert("❌ Failed: " + JSON.stringify(err));
        return;
      }

      loadAdminIncidents();
    }

    async function loadTimeline(incidentId) {
      const res = await fetch(`${API_BASE}/incidents/${incidentId}/timeline`);
      const data = await res.json();

      let html = "<h3>Incident Timeline</h3>";
      data.forEach(step => {
        html += `
          <div>
            <b>${step.status}</b> —
            ${new Date(step.changed_at).toLocaleString()}
          </div>
        `;
      });

      alert(html.replace(/<[^>]*>/g, ""));
    }

    loadAdminIncidents();
  </script>

</body>
</html>
